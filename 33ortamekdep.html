<!DOCTYPE html>
<html lang="tk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.5" />
  <title>Admin ‚Äî √ùe≈àil</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#0d9488; --primary-light:#6ee7b7; --success:#06d6a0; --danger:#ef476f;
      --light-bg:#f9fafb; --dark-bg:#0f172a; --card-light:#ffffff; --card-dark:#1e293b;
      --text-light:#1e293b; --text-dark:#f1f5f9; --border-light:#e2e8f0; --border-dark:#334155;
      --shadow:0 8px 24px rgba(0,0,0,0.08); --shadow-dark:0 8px 24px rgba(0,0,0,0.2);
      --radius:20px; --transition:all 0.3s cubic-bezier(0.25,0.8,0.25,1);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif; font-size:16px; background:var(--light-bg); color:var(--text-light);
      transition:var(--transition); min-height:100vh; display:flex; flex-direction:column;}
    body.dark-mode{background:var(--dark-bg); color:var(--text-dark)}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    .header{padding:20px 0;position:sticky;top:0;background:var(--card-light);box-shadow:var(--shadow);z-index:100}
    body.dark-mode .header{background:var(--card-dark);box-shadow:var(--shadow-dark)}
    .navbar{display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:1.8rem;font-weight:700;color:var(--primary);text-decoration:none;display:flex;align-items:center;gap:10px}
    .theme-toggle{background:var(--primary);border:none;width:48px;height:48px;border-radius:50%;color:white;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);box-shadow:var(--shadow)}
    .theme-toggle:hover{transform:rotate(180deg);background:var(--primary-light)}
    .main{padding:40px 0;flex:1}
    .page-title{text-align:center;font-size:2.4rem;margin-bottom:20px;color:var(--primary);font-weight:700}
    .tabs{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;justify-content:center}
    .tab-btn{position:relative;background:var(--card-light);border:none;padding:12px 20px;border-radius:14px;font-weight:700;font-size:1rem;cursor:pointer;transition:var(--transition);box-shadow:var(--shadow);display:flex;align-items:center;gap:8px;color:var(--text-light)}
    .tab-btn.active{background:var(--primary);color:white;transform:translateY(-2px)}
    .badge{position:absolute;top:-8px;right:-8px;background:var(--danger);color:white;font-size:0.75rem;font-weight:800;padding:4px 10px;border-radius:20px}
    .content-area{min-height:300px;margin-top:10px}
    .empty-state{text-align:center;padding:40px 20px;color:#64748b;font-style:italic;font-size:1.05rem;border-radius:12px;background:var(--card-light);box-shadow:var(--shadow)}
    body.dark-mode .empty-state{background:var(--card-dark);box-shadow:var(--shadow-dark)}
    .order-item, .question-item{background:var(--card-light);padding:20px;border-radius:12px;margin-bottom:18px;box-shadow:var(--shadow);position:relative;border:1px solid var(--border-light)}
    body.dark-mode .order-item, body.dark-mode .question-item{background:var(--card-dark);border-color:var(--border-dark)}
    .order-header{font-weight:800;color:var(--primary);margin-bottom:10px;display:flex;gap:8px;align-items:center}
    .order-detail{margin:6px 0;font-size:0.95rem}
    .media-preview{margin:12px 0;text-align:center}
    .media-preview img, .media-preview video{max-width:100%;max-height:300px;border-radius:10px}
    .priority-badge{position:absolute;top:18px;right:18px;background:var(--danger);color:white;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.85rem;cursor:pointer}
    .priority-badge.checked{background:var(--success)}
    .action-buttons{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .action-btn{padding:8px 14px;background:var(--primary);color:white;border-radius:10px;text-decoration:none;font-weight:600}
    .loading {text-align:center;padding:20px;}
    .status {margin-bottom:12px;font-size:0.95rem;color:#374151}
    .error {color:var(--danger);font-weight:700}
    footer{text-align:center;padding:18px;opacity:0.8;font-size:0.95rem;margin-top:auto;border-top:1px solid var(--border-light)}
    body.dark-mode footer{border-top-color:var(--border-dark)}
    @media(max-width:650px){.tabs{flex-direction:column;align-items:center}.tab-btn{width:100%;max-width:340px;justify-content:center}.action-buttons{flex-direction:column}.action-btn{width:100%}}
  </style>
</head>
<body class="light-mode">
  <header class="header">
    <div class="container navbar">
      <a href="#" class="logo">‚öôÔ∏è √ùe≈àil Admin</a>
      <button class="theme-toggle" id="theme-toggle" aria-label="Renglerini almasdyr">üåô</button>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <h1 class="page-title">Ho≈ü geldi≈à, Admin!</h1>

      <div class="tabs" role="tablist" aria-label="Bo'limlar">
        <button class="tab-btn active" data-tab="rail" aria-selected="true">üöÜ √ùe≈àil demir√Ωollary <span class="badge" id="badge-rail">0</span></button>
        <button class="tab-btn" data-tab="pay">üí≥ √ùe≈àil Pay <span class="badge" id="badge-pay">0</span></button>
        <button class="tab-btn" data-tab="help">üìû K√∂mek bo'limi <span class="badge" id="badge-help">0</span></button>
      </div>

      <div class="status" id="status">‚úÖ Ulanƒ±≈ü tayyor.</div>

      <div class="content-area" id="content-area">
        <div class="empty-state">Bo'limni tanla≈à</div>
      </div>
    </div>
  </main>

  <footer>¬© 2025 √ùe≈àil. Hemma hukuklar goralan.</footer>

  <script>
    // ---------- CONFIG ----------
    const APP_ID = 'C3BB5032-1DCC-4DB3-888F-AEDA785F26CB'; // Application ID (ok)
    const JS_KEY  = '9A8CACA4-5889-4D47-903E-BF12F059E175'; // **JS API key** (Frontend uchun)
    const PAGE_SIZE = 1000;

    // ---------- UI refs ----------
    const themeToggle = document.getElementById('theme-toggle');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const contentArea = document.getElementById('content-area');
    const statusEl = document.getElementById('status');
    const badgeRail = document.getElementById('badge-rail');
    const badgePay = document.getElementById('badge-pay');
    const badgeHelp = document.getElementById('badge-help');

    // ---------- Theme ----------
    const savedTheme = localStorage.getItem('theme') || 'light-mode';
    document.body.className = savedTheme;
    themeToggle.textContent = savedTheme === 'dark-mode' ? '‚òÄÔ∏è' : 'üåô';
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      document.body.classList.toggle('light-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark-mode' : 'light-mode');
      themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    });

    // ---------- State ----------
    let allOrders = [];
    let allQuestions = [];
    let isFetching = false;
    let lastFetchError = null;

    // ---------- Event: tabs ----------
    tabButtons.forEach(btn => btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadTabContent(btn.dataset.tab);
    }));

    // ---------- Helper: build Backendless URL ----------
    function backendlessUrl(path) {
      return `https://api.backendless.com/${APP_ID}/${JS_KEY}/${path}`;
    }

    // ---------- Fetch all data ----------
    async function fetchAllData() {
      isFetching = true;
      lastFetchError = null;
      statusEl.textContent = '‚è≥ Ma\'lumotlar yuklanmoqda...';
      try {
        const [ordersRes, questionsRes] = await Promise.all([
          fetch(backendlessUrl(`data/orders?pageSize=${PAGE_SIZE}`)),
          fetch(backendlessUrl(`data/questions?pageSize=${PAGE_SIZE}`))
        ]);

        if (!ordersRes.ok) {
          const errText = await ordersRes.text().catch(()=> 'Orders fetch failed');
          throw new Error('Orders fetch failed: ' + errText);
        }
        if (!questionsRes.ok) {
          const errText = await questionsRes.text().catch(()=> 'Questions fetch failed');
          throw new Error('Questions fetch failed: ' + errText);
        }

        const ordersData = await ordersRes.json();
        const questionsData = await questionsRes.json();

        // Backendless may return array directly or wrapped -> normalize
        allOrders = Array.isArray(ordersData) ? ordersData : (ordersData.data || []);
        allQuestions = Array.isArray(questionsData) ? questionsData : (questionsData.data || []);

        updateBadges();
        statusEl.textContent = `‚úÖ Yuklandi: ${allOrders.length} buyurtma, ${allQuestions.length} sorag.`;
        lastFetchError = null;
        loadActiveTab();
      } catch (err) {
        console.error('Ma\'lumot yuklanmadi:', err);
        lastFetchError = err;
        statusEl.innerHTML = `<span class="error">‚ùå Yuklash xatosi: ${escapeHtml(err.message)}</span>`;
        contentArea.innerHTML = `<div class="empty-state">Ma'lumotni olishda xato yuz berdi. Konsolni tekshiri≈à.</div>`;
      } finally {
        isFetching = false;
      }
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // ---------- Update badges ----------
    function updateBadges() {
      const railCount = allOrders.filter(o => o.type === 'demiryol' && !o.priorityChecked).length;
      const payCount = allOrders.filter(o => ['pay-buy','pay-sell'].includes(o.type) && !o.priorityChecked).length;
      const helpCount = allQuestions.filter(q => !q.priorityChecked).length;
      badgeRail.textContent = railCount || '';
      badgePay.textContent = payCount || '';
      badgeHelp.textContent = helpCount || '';
    }

    function loadActiveTab() {
      const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab || 'rail';
      loadTabContent(activeTab);
    }

    // ---------- Media helpers ----------
    function getMediaType(url) {
      if (!url) return null;
      const lower = url.toLowerCase();
      if (lower.includes('/files/')) return 'image';
      if (/\.(mp4|mov|avi|webm|mkv)(\?|$)/.test(lower)) return 'video';
      if (/\.(jpe?g|png|gif|webp|svg)(\?|$)/.test(lower)) return 'image';
      return null;
    }

    function renderMediaPreview(url) {
      if (!url) return '';
      const type = getMediaType(url);
      if (type === 'video') {
        return `<div class="media-preview"><video controls><source src="${url}">Video ochilmadi</video></div>`;
      } else if (type === 'image') {
        return `<div class="media-preview"><img src="${url}" alt="Tassyklama" onerror="this.parentElement.style.display='none'"></div>`;
      }
      return '';
    }

    // ---------- Renderers ----------
    function buildSmsTemplates(order) {
      const travelDate = formatDate(order.travelDate);
      const route = order.route || '‚Äî';
      const totalPrice = order.totalPrice || order.total || '00';
      const sms1 = `‚úÖ Salam gadyrly m√º≈üderi sizi≈à ${travelDate} ${route} ugry bo√Ωun√ßa sargydy≈àyz kabul edildi. I≈à tiz zamanda bron kody iberiler. Sagbolu≈à.`;
      const sms2 = `üéâ Salam, sizi≈à ${travelDate} ${route} buyurtmany≈àyz √Ωerine √Ωetirildi. Bron kody: 000000.`;
      const sms3 = `‚úÖ Salam, sargydy≈àyz kabul edildi. T√∂leg talap edil√Ω√§r: ${totalPrice} TMT.`;
      return { sms1, sms2, sms3 };
    }

    function formatDate(val) {
      if (!val) return '‚Äî';
      if (typeof val === 'number') return new Date(val).toLocaleDateString('tk-TM');
      const d = new Date(val);
      return isNaN(d) ? val : d.toLocaleDateString('tk-TM');
    }

    function renderRailTab() {
      const railOrders = allOrders.filter(o => o.type === 'demiryol').sort((a,b)=>(b.created||0)-(a.created||0));
      if (!railOrders.length) {
        contentArea.innerHTML = `<div class="empty-state">Demir√Ωol buyurtmasy √Ωok.</div>`;
        return;
      }
      const html = railOrders.map(order => {
        const birthDate = order.birthdate ? new Date(order.birthdate).toLocaleDateString('tk-TM') : '‚Äî';
        const route = order.route || '‚Äî';
        const travelDate = formatDate(order.travelDate);
        const totalPrice = order.totalPrice || order.total || '00';
        const phone = order.clientPhone || order.phone || '';
        const proofType = order.proof_type || order.proofType || 'unknown';
        const proofText = (proofType === 'screenshot' || proofType === 'file') ? 'Skrinshot' : (proofType === 'sms' ? 'SMS habary' : '‚Äî');
        const mediaUrl = order.proof_url || order.image_url || order.fileUrl || order.screenshotUrl || '';
        const mediaPreview = renderMediaPreview(mediaUrl);
        const { sms1, sms2, sms3 } = buildSmsTemplates(order);
        return `
          <div class="order-item">
            <div class="order-header">üöÜ Demir√Ωol ‚Äî ${escapeHtml(route)}</div>
            <div class="order-detail"><strong>Ady/Famili√Ωa:</strong> ${escapeHtml(`${order.name||''} ${order.surname||''}`)}</div>
            <div class="order-detail"><strong>Doglan g√ºni:</strong> ${escapeHtml(birthDate)}</div>
            <div class="order-detail"><strong>Passport:</strong> ${escapeHtml(order.passport||'‚Äî')}</div>
            <div class="order-detail"><strong>Sapar senesi:</strong> ${escapeHtml(travelDate)}</div>
            <div class="order-detail"><strong>Jemi:</strong> ${escapeHtml(totalPrice)} TMT</div>
            <div class="order-detail"><strong>Nomer:</strong> ${escapeHtml(phone)}</div>
            <div class="order-detail"><strong>Tassyklama:</strong> ${escapeHtml(proofText)}</div>
            ${mediaPreview}
            <div class="order-detail"><strong>Wagt:</strong> ${order.created ? new Date(order.created).toLocaleString('tk-TM') : '‚Äî'}</div>
            <div class="priority-badge ${order.priorityChecked ? 'checked' : ''}" data-id="${order.objectId}" data-type="orders">√úst√ºnlikli</div>
            <div class="action-buttons">
              <a href="sms:${phone}?body=${encodeURIComponent(sms1)}" class="action-btn">Kabul edildi</a>
              <a href="sms:${phone}?body=${encodeURIComponent(sms2)}" class="action-btn">Bilet alyndy</a>
              <a href="sms:${phone}?body=${encodeURIComponent(sms3)}" class="action-btn">Doly t√∂leg</a>
            </div>
          </div>
        `;
      }).join('');
      contentArea.innerHTML = html;
      bindPriorityButtons();
    }

    function renderPayTab() {
      const payOrders = allOrders.filter(o => ['pay-buy','pay-sell'].includes(o.type)).sort((a,b)=>(b.created||0)-(a.created||0));
      if (!payOrders.length) {
        contentArea.innerHTML = `<div class="empty-state">√ùe≈àil Pay buyurtmasy √Ωok.</div>`;
        return;
      }
      const html = payOrders.map(order => {
        const typeText = order.type === 'pay-buy' ? 'Satyn almak' : 'Satmak';
        const crypto = order.crypto || 'Kripto';
        const amount = order.amount || order.amount_value || '0';
        const total = order.totalPrice || order.total || '00';
        const phone = order.clientPhone || order.phone || '';
        const proofType = order.proof_type || order.proofType || 'unknown';
        const proofText = (proofType === 'screenshot' || proofType === 'file') ? 'Skrinshot' : (proofType === 'sms' ? 'SMS habary' : '‚Äî');
        const mediaUrl = order.proof_url || order.image_url || order.fileUrl || order.screenshotUrl || '';
        const mediaPreview = renderMediaPreview(mediaUrl);
        const paySms1 = `üéâ Salam, sizi≈à ${typeText} ‚Äî ${amount} ${crypto} eden sargydy≈àyz √Ωerine √Ωetirildi.`;
        const paySms2 = `‚úÖ Salam, sargydy≈àyz kabul edildi. T√∂leg talap edil√Ω√§r: ${total} TMT.`;
        return `
          <div class="order-item">
            <div class="order-header">üí∏ ${typeText} ‚Äî ${escapeHtml(crypto)}</div>
            <div class="order-detail"><strong>Miqdary:</strong> ${escapeHtml(amount)}</div>
            <div class="order-detail"><strong>Jemi:</strong> ${escapeHtml(total)} TMT</div>
            ${order.type === 'pay-sell' ? `<div class="order-detail"><strong>Maxfiy s√∂z:</strong> ${escapeHtml(order.secret_code || order.secretCode || '‚Äî')}</div>` : ''}
            <div class="order-detail"><strong>Nomer:</strong> ${escapeHtml(phone)}</div>
            <div class="order-detail"><strong>Tassyklama:</strong> ${escapeHtml(proofText)}</div>
            ${mediaPreview}
            <div class="order-detail"><strong>Wagt:</strong> ${order.created ? new Date(order.created).toLocaleString('tk-TM') : '‚Äî'}</div>
            <div class="priority-badge ${order.priorityChecked ? 'checked' : ''}" data-id="${order.objectId}" data-type="orders">√úst√ºnlikli</div>
            <div class="action-buttons">
              <a href="sms:${phone}?body=${encodeURIComponent(paySms1)}" class="action-btn">√ùerine √Ωetirildi</a>
              <a href="sms:${phone}?body=${encodeURIComponent(paySms2)}" class="action-btn">T√∂leg talap</a>
            </div>
          </div>
        `;
      }).join('');
      contentArea.innerHTML = html;
      bindPriorityButtons();
    }

    function renderHelpTab() {
      const questions = allQuestions.sort((a,b)=>(b.created||0)-(a.created||0));
      if (!questions.length) {
        contentArea.innerHTML = `<div class="empty-state">Sorag √Ωok.</div>`;
        return;
      }
      const html = questions.map(q => {
        const proofType = q.proof_type || q.proofType || 'unknown';
        const proofText = (proofType === 'screenshot' || proofType === 'file') ? 'Skrinshot' : (proofType === 'sms' ? 'SMS habary' : '‚Äî');
        const mediaUrl = q.proof_url || q.image_url || q.fileUrl || q.screenshotUrl || '';
        const mediaPreview = renderMediaPreview(mediaUrl);
        return `
          <div class="question-item">
            <div class="order-header">üôã ${escapeHtml(q.name || 'Anonim')}</div>
            <div class="order-detail"><strong>Nomer:</strong> ${escapeHtml(q.phone || '‚Äî')}</div>
            <div class="order-detail"><strong>Sorag:</strong> ${escapeHtml(q.question || '‚Äî')}</div>
            <div class="order-detail"><strong>Tassyklama:</strong> ${escapeHtml(proofText)}</div>
            ${mediaPreview}
            <div class="order-detail"><small>${q.created ? new Date(q.created).toLocaleString('tk-TM') : '‚Äî'}</small></div>
            <div class="priority-badge ${q.priorityChecked ? 'checked' : ''}" data-id="${q.objectId}" data-type="questions">√úst√ºnlikli</div>
          </div>
        `;
      }).join('');
      contentArea.innerHTML = html;
      bindPriorityButtons();
    }

    function bindPriorityButtons() {
      document.querySelectorAll('.priority-badge').forEach(badge => {
        badge.removeEventListener('click', togglePriority); // ensure no dup
        badge.addEventListener('click', togglePriority);
      });
    }

    // ---------- Toggle priority (PUT to Backendless) ----------
    async function togglePriority(e) {
      const badge = e.currentTarget;
      const objectId = badge.dataset.id;
      const type = badge.dataset.type;
      const isChecked = badge.classList.contains('checked');
      const url = backendlessUrl(`data/${type}/${objectId}`);

      const updateData = isChecked
        ? { priorityChecked: null, priorityExpiresAt: null }
        : { priorityChecked: true, priorityExpiresAt: Date.now() + 3*24*60*60*1000 };

      try {
        const res = await fetch(url, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(updateData)
        });
        if (!res.ok) {
          const txt = await res.text().catch(()=> 'Failed to update');
          throw new Error('Update failed: ' + txt);
        }
        // Update local copy
        if (type === 'orders') {
          const idx = allOrders.findIndex(o => o.objectId === objectId);
          if (idx !== -1) allOrders[idx] = {...allOrders[idx], ...updateData};
        } else {
          const idx = allQuestions.findIndex(q => q.objectId === objectId);
          if (idx !== -1) allQuestions[idx] = {...allQuestions[idx], ...updateData};
        }
        updateBadges();
        loadActiveTab();
      } catch (err) {
        console.error('Prioritet yangilanmadi:', err);
        alert('Prioritetni yangilab bo\'lmadi: ' + err.message);
      }
    }

    // ---------- Load tab content ----------
    function loadTabContent(tab) {
      if (isFetching) {
        contentArea.innerHTML = `<div class="loading">‚è≥ Yuklanmoqda...</div>`;
        return;
      }
      if (lastFetchError) {
        contentArea.innerHTML = `<div class="empty-state">Ma'lumotni olishda xato bor. Qayta urinib ko'ring.</div>`;
        return;
      }
      if (tab === 'rail') renderRailTab();
      else if (tab === 'pay') renderPayTab();
      else if (tab === 'help') renderHelpTab();
      else contentArea.innerHTML = `<div class="empty-state">Bo'lim topilmadi.</div>`;
    }

    // ---------- Initial load ----------
    fetchAllData();
    loadTabContent('rail');
    // Auto refresh every 30s
    setInterval(fetchAllData, 30000);

    // ---------- Accessibility: keyboard navigation for tabs ----------
    document.addEventListener('keydown', (e) => {
      const focused = document.activeElement;
      if (!focused || !focused.classList.contains('tab-btn')) return;
      let idx = Array.from(tabButtons).indexOf(focused);
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        idx = (idx + 1) % tabButtons.length;
        tabButtons[idx].focus();
        tabButtons[idx].click();
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        idx = (idx - 1 + tabButtons.length) % tabButtons.length;
        tabButtons[idx].focus();
        tabButtons[idx].click();
      }
    });

    // ---------- End of script ----------
  </script>
</body>
</html>
